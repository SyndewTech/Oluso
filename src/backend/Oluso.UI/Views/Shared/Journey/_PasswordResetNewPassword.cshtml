@using Oluso.UserJourneys.Steps
@model PasswordResetNewPasswordViewModel

<div class="reset-card">
    <h1 class="title">Create New Password</h1>
    <p class="subtitle">Enter your new password below.</p>

    @if (!string.IsNullOrEmpty(Model?.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <form method="post" id="newPasswordForm">
        <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password"
                   id="new_password"
                   name="new_password"
                   class="form-control"
                   autocomplete="new-password"
                   autofocus
                   required
                   data-min-length="@Model?.MinLength"
                   data-require-uppercase="@Model?.RequireUppercase.ToString().ToLower()"
                   data-require-lowercase="@Model?.RequireLowercase.ToString().ToLower()"
                   data-require-digit="@Model?.RequireDigit.ToString().ToLower()"
                   data-require-special="@Model?.RequireNonAlphanumeric.ToString().ToLower()" />
            <div class="password-requirements" id="passwordRequirements">
                <small class="req-header">Password requirements:</small>
                <ul>
                    <li id="req-length" class="req-item">
                        <span class="req-icon"></span>
                        At least @Model?.MinLength characters
                    </li>
                    @if (Model?.RequireUppercase == true)
                    {
                        <li id="req-uppercase" class="req-item">
                            <span class="req-icon"></span>
                            One uppercase letter
                        </li>
                    }
                    @if (Model?.RequireLowercase == true)
                    {
                        <li id="req-lowercase" class="req-item">
                            <span class="req-icon"></span>
                            One lowercase letter
                        </li>
                    }
                    @if (Model?.RequireDigit == true)
                    {
                        <li id="req-digit" class="req-item">
                            <span class="req-icon"></span>
                            One number
                        </li>
                    }
                    @if (Model?.RequireNonAlphanumeric == true)
                    {
                        <li id="req-special" class="req-item">
                            <span class="req-icon"></span>
                            One special character
                        </li>
                    }
                </ul>
            </div>
        </div>

        <div class="form-group">
            <label for="confirm_password">Confirm Password</label>
            <input type="password"
                   id="confirm_password"
                   name="confirm_password"
                   class="form-control"
                   autocomplete="new-password"
                   required />
            <div id="confirmMessage" class="confirm-message"></div>
        </div>

        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">Reset Password</button>
    </form>
</div>

<style>
.reset-card {
    max-width: 400px;
    margin: 0 auto;
    padding: 2rem;
}

.title {
    margin-bottom: 0.5rem;
}

.subtitle {
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-control {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    box-sizing: border-box;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color, #4f46e5);
    box-shadow: 0 0 0 3px var(--primary-light, rgba(79, 70, 229, 0.15));
}

.password-requirements {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    font-size: 0.875rem;
}

.req-header {
    font-weight: 500;
    color: #495057;
    display: block;
    margin-bottom: 0.5rem;
}

.password-requirements ul {
    margin: 0;
    padding: 0;
    list-style: none;
}

.req-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
    color: #6c757d;
    transition: color 0.2s;
}

.req-item.met {
    color: #198754;
}

.req-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 2px solid currentColor;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
}

.req-item.met .req-icon {
    background: #198754;
    border-color: #198754;
}

.req-item.met .req-icon::after {
    content: '';
    width: 6px;
    height: 3px;
    border-left: 2px solid white;
    border-bottom: 2px solid white;
    transform: rotate(-45deg) translateY(-1px);
}

.confirm-message {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    min-height: 1.25rem;
}

.confirm-message.match {
    color: #198754;
}

.confirm-message.no-match {
    color: #dc3545;
}

.btn-block {
    display: block;
    width: 100%;
}

.btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}
</style>

<script>
(function() {
    var passwordInput = document.getElementById('new_password');
    var confirmInput = document.getElementById('confirm_password');
    var confirmMessage = document.getElementById('confirmMessage');
    var submitBtn = document.getElementById('submitBtn');

    var minLength = parseInt(passwordInput.dataset.minLength) || 8;
    var requireUppercase = passwordInput.dataset.requireUppercase === 'true';
    var requireLowercase = passwordInput.dataset.requireLowercase === 'true';
    var requireDigit = passwordInput.dataset.requireDigit === 'true';
    var requireSpecial = passwordInput.dataset.requireSpecial === 'true';

    function validatePassword() {
        var password = passwordInput.value;
        var allMet = true;

        // Length check
        var lengthEl = document.getElementById('req-length');
        if (lengthEl) {
            var lengthMet = password.length >= minLength;
            lengthEl.classList.toggle('met', lengthMet);
            if (!lengthMet) allMet = false;
        }

        // Uppercase check
        var upperEl = document.getElementById('req-uppercase');
        if (upperEl && requireUppercase) {
            var upperMet = /[A-Z]/.test(password);
            upperEl.classList.toggle('met', upperMet);
            if (!upperMet) allMet = false;
        }

        // Lowercase check
        var lowerEl = document.getElementById('req-lowercase');
        if (lowerEl && requireLowercase) {
            var lowerMet = /[a-z]/.test(password);
            lowerEl.classList.toggle('met', lowerMet);
            if (!lowerMet) allMet = false;
        }

        // Digit check
        var digitEl = document.getElementById('req-digit');
        if (digitEl && requireDigit) {
            var digitMet = /[0-9]/.test(password);
            digitEl.classList.toggle('met', digitMet);
            if (!digitMet) allMet = false;
        }

        // Special character check
        var specialEl = document.getElementById('req-special');
        if (specialEl && requireSpecial) {
            var specialMet = /[^a-zA-Z0-9]/.test(password);
            specialEl.classList.toggle('met', specialMet);
            if (!specialMet) allMet = false;
        }

        return allMet;
    }

    function validateConfirm() {
        var password = passwordInput.value;
        var confirm = confirmInput.value;

        if (!confirm) {
            confirmMessage.textContent = '';
            confirmMessage.className = 'confirm-message';
            return false;
        }

        if (password === confirm) {
            confirmMessage.textContent = 'Passwords match';
            confirmMessage.className = 'confirm-message match';
            return true;
        } else {
            confirmMessage.textContent = 'Passwords do not match';
            confirmMessage.className = 'confirm-message no-match';
            return false;
        }
    }

    function updateSubmitButton() {
        var passwordValid = validatePassword();
        var confirmValid = validateConfirm();
        // Don't disable the button, let server validation handle it
        // This is just for visual feedback
    }

    passwordInput.addEventListener('input', function() {
        validatePassword();
        if (confirmInput.value) {
            validateConfirm();
        }
    });

    confirmInput.addEventListener('input', validateConfirm);

    // Initial validation if password has value (e.g., after error)
    if (passwordInput.value) {
        validatePassword();
    }
})();
</script>
